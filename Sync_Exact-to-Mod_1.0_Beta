/**
*	ADWORDS EXACT TO MODIFIED BROAD SYNC
*	NORISK GMBH
*	AGROSS@NORISKSHOP.DE
*/

function main() {

/************** CONFIG_BLOCK START *****************/

  var CAMPAIGN_SUFFIX = "_AT";		// ["RLSA"|"AT"|...] 
  var LOG_DATA = "ON";				// ["ON"|"OFF"] LOGS DATA TO ADWORDS LOGGER
  var STATUS = "ENABLED";
  
/************** CONFIG_BLOCK END   *****************/

  syncKeywords(LOG_DATA,CAMPAIGN_SUFFIX, STATUS);
  
}

function syncKeywords(LOG_DATA,CAMPAIGN_SUFFIX, STATUS){
	var labelIterator = AdWordsApp.labels().withCondition('Name = "MODIFIED/BROAD"').get();
  
  	if(labelIterator.hasNext()){
   		var label = labelIterator.next();
   		var campaignIterator = label.campaigns().get();
    
    	while(campaignIterator.hasNext()){
     		var modifiedCampaign = campaignIterator.next();
      
      		if(LOG_DATA=="ON"){
              Logger.log("Modified Campaign: " + modifiedCampaign.getName());
      		}
      
    		var exactCampaignName = modifiedCampaign.getName().replace(">ModBr", "");
     		var exactCampaignIterator = AdWordsApp.campaigns().withCondition('Name = "' + exactCampaignName + '"').get();
      
      		if(exactCampaignIterator.hasNext()){
        		var exactCampaign = exactCampaignIterator.next();
        		
        		if(LOG_DATA=="ON"){
                  Logger.log("Exact Campaign: " + exactCampaign.getName());
       			}
        
        		var exactAdGroupIterator = exactCampaign.adGroups().get();
        
        		while(exactAdGroupIterator.hasNext()){
         			var exactAdGroup = exactAdGroupIterator.next();          
         			var modifiedAdGroups = modifiedCampaign.adGroups().withCondition('Name = "' + exactAdGroup.getName() + '"').get();
         			
         			if(LOG_DATA=="ON"){
                      Logger.log("Exact AdGroup: " + exactAdGroup.getName());
          			}
                    
                  if(modifiedAdGroups.totalNumEntities()==0){
                   var newAdGroupOperation = modifiedCampaign.newAdGroupBuilder().withName(exactAdGroup.getName()).withStatus(STATUS).build();
                   var newAdGroup = newAdGroupOperation.getResult();
                   var exactKeywordIterator = exactAdGroup.keywords().get();
                    
                    if(LOG_DATA=="ON"){
                          Logger.log("Modified AdGroup: " + modifiedAdGroup.getName());
            			}
            			
            			while(exactKeywordIterator.hasNext()){
             				var exactKeyword = exactKeywordIterator.next();
             				
              				if(LOG_DATA=="ON"){
                              Logger.log("Exact Keyword: " + exactKeyword.getText());
              				}
              				
             				var exactToModifiedKeywordText = exactKeyword.getText();
             				exactToModifiedKeywordText = exactToModifiedKeywordText.replace("[", "+").replace("]","").replace(" ", " +");
             				
              				
            					var keywordOperation = newAdGroup.newKeywordBuilder().withText(exactToModifiedKeywordText).build();
              					var modifiedKeyword = keywordOperation.getResult();
              					
              					if(LOG_DATA=="ON"){
                                  Logger.log("Modified Keyword Text: " + modifiedKeyword.getText());
              					}
 	
                            	newAdGroup.createNegativeKeyword(exactKeyword.getText());
                            
                            	if(LOG_DATA=="ON"){
                                	Logger.log("Negative Keyword Text: " + exactKeyword.getText());
              					}
                          	
            			}
                  }
          			
          			if(modifiedAdGroups.hasNext()){
            			var modifiedAdGroup = modifiedAdGroups.next();
       	    			var exactKeywordIterator = exactAdGroup.keywords().get();
       	    			
            			if(LOG_DATA=="ON"){
                          Logger.log("Modified AdGroup: " + modifiedAdGroup.getName());
            			}
            			
            			while(exactKeywordIterator.hasNext()){
             				var exactKeyword = exactKeywordIterator.next();
             				
              				if(LOG_DATA=="ON"){
                              Logger.log("Exact Keyword: " + exactKeyword.getText());
              				}
              				
             				var exactToModifiedKeywordText = exactKeyword.getText();
             				exactToModifiedKeywordText = exactToModifiedKeywordText.replace("[", "+").replace("]","").replace(" ", " +");
             				
              				var modifiedKeywords = modifiedAdGroup.keywords().withCondition("Text = '" + exactToModifiedKeywordText + "'").get();
              
              				if(modifiedKeywords.totalNumEntities()==0){
            					var keywordOperation = modifiedAdGroup.newKeywordBuilder().withText(exactToModifiedKeywordText).build();
              					var modifiedKeyword = keywordOperation.getResult();
              					
              					if(LOG_DATA=="ON"){
                                  Logger.log("Modified Keyword Text: " + modifiedKeyword.getText());
              					}
              				}
                          
                        	var negativeKeywords = modifiedAdGroup.negativeKeywords().withCondition("Text = '" + exactToModifiedKeywordText + "'").get();
                           
                          	if(negativeKeywords.totalNumEntities()==0){
                            	modifiedAdGroup.createNegativeKeyword(exactKeyword.getText());
                            
                            	if(LOG_DATA=="ON"){
                                	Logger.log("Negative Keyword Text: " + exactKeyword.getText());
              					}
                          	}
            			}
          			}
        		}
      		}
    	}
  	}
}
